<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<!-- Ensures responsiveness on iPhone and other devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Study Planner</title>
<style>
:root {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  margin:0; padding:0;
  color-scheme: light dark;
  --accent-color: #007aff;
  --primary-color: #007aff;
  --secondary-color: #555;
  --danger-color: #ff3b30;
  --success-color: #34c759;
  --background-light: #f9f9f9;
  --background-dark: #1c1c1c;
}

/* Light Mode */
@media (prefers-color-scheme: light) {
  body { background:#f9f9f9; color:#111; }
  header, .set, .new-set-form, .confirm-modal .modal-content {
    background:#fff;
    border:1px solid #ddd;
  }
  input, .btn, .increment-button, .toggle-schedule {
    background:#f1f1f1; color:#111; border:1px solid #ccc;
  }
  progress { background:#e0e0e0; border:1px solid #ccc; }
  progress::-webkit-progress-value { background:var(--accent-color); }
}

/* Dark Mode */
@media (prefers-color-scheme: dark) {
  body { background:#1c1c1c; color:#e0e0e0; }
  header, .set, .new-set-form, .confirm-modal .modal-content {
    background:#2c2c2c;
    border:1px solid #444;
  }
  input, .btn, .increment-button, .toggle-schedule {
    background:#3a3a3a; color:#e0e0e0; border:1px solid #555;
  }
  progress { background:#333; border:1px solid #444; }
  progress::-webkit-progress-value { background:var(--accent-color); }
}

body, html {
  margin:0; padding:0;
  overflow-x:hidden;
  line-height:1.5;
  position:relative;
  min-height:100%;
}

/* Header */
header {
  display:flex; align-items:center; justify-content:space-between;
  padding:0.5rem 1rem; box-sizing:border-box;
  position:relative;
}
.header-left, .header-right {
  flex:0 0 auto; display:flex; align-items:center;
}
.header-center {
  flex:1; display:flex; align-items:center; justify-content:center;
}
header button#addSetBtn {
  cursor:pointer; padding:0.5rem 1rem; border:none; border-radius:0.5rem;
  color: #fff; background-color: var(--primary-color);
  font-weight:600; font-size:1rem;
  display: flex; align-items: center; justify-content: center;
}
header button#addSetBtn:hover {
  background-color: #006ae6; /* Darken manually since CSS function removed */
}
header button#addSetBtn:active {
  background-color: #0055cc; /* Further darken manually */
}

/* Button Styles */
.btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.9rem;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.btn-primary {
  background-color: var(--primary-color);
  color: #fff;
}

.btn-primary:hover {
  background-color: #006ae6; /* Darken manually */
}

.btn-primary:active {
  background-color: #0055cc; /* Further darken manually */
  transform: scale(0.98);
}

.btn-secondary {
  background-color: var(--secondary-color);
  color: #fff;
}

.btn-secondary:hover {
  background-color: #444; /* Darken manually */
}

.btn-secondary:active {
  background-color: #333; /* Further darken manually */
  transform: scale(0.98);
}

.btn-danger {
  background-color: var(--danger-color);
  color: #fff;
}

.btn-danger:hover {
  background-color: #e32d24; /* Darken manually */
}

.btn-danger:active {
  background-color: #c6231f; /* Further darken manually */
  transform: scale(0.98);
}

.btn-success {
  background-color: var(--success-color);
  color: #fff;
}

.btn-success:hover {
  background-color: #2fa749; /* Darken manually */
}

.btn-success:active {
  background-color: #25843d; /* Further darken manually */
  transform: scale(0.98);
}

.btn-icon {
  background-color: transparent;
  color: inherit;
  font-size: 1.5rem;
  padding: 0.3rem;
}

.btn-icon:hover {
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 0.5rem;
}

.btn-small {
  padding: 0.3rem 0.6rem;
  font-size: 0.8rem;
  border-radius: 0.3rem;
}

.btn-small.btn-primary {
  background-color: var(--primary-color);
  color: #fff;
}

.btn-small.btn-primary:hover {
  background-color: #006ae6; /* Darken manually */
}

.btn-small.btn-primary:active {
  background-color: #0055cc; /* Further darken manually */
}

.btn-small.btn-secondary {
  background-color: var(--secondary-color);
  color: #fff;
}

.btn-small.btn-secondary:hover {
  background-color: #444; /* Darken manually */
}

.btn-small.btn-secondary:active {
  background-color: #333; /* Further darken manually */
}

.btn-small.btn-danger {
  background-color: var(--danger-color);
  color: #fff;
}

.btn-small.btn-danger:hover {
  background-color: #e32d24; /* Darken manually */
}

.btn-small.btn-danger:active {
  background-color: #c6231f; /* Further darken manually */
}

.btn-small.btn-success {
  background-color: var(--success-color);
  color: #fff;
}

.btn-small.btn-success:hover {
  background-color: #2fa749; /* Darken manually */
}

.btn-small.btn-success:active {
  background-color: #25843d; /* Further darken manually */
}

/* Main */
main {
  padding:1rem; max-width:600px; margin:0 auto; box-sizing:border-box; width:100%;
}

/* Forms */
.new-set-form {
  display:none; flex-direction:column; gap:0.5rem; margin-bottom:1rem; align-items:stretch;
  border-radius:0.3rem; padding:1rem;
}
.new-set-form input {
  padding:0.5rem; font-size:1rem; border-radius:0.3rem; border:1px solid #ccc;
}
.new-set-form button.action {
  /* Replaced with btn-primary class */
}

/* Sets */
.sets {
  display:flex; flex-direction:column; gap:1rem; margin-top:1rem;
}

.set {
  border-radius:0.3rem; padding:1rem; display:flex; flex-direction:column; gap:0.5rem;
}

.set-header {
  display:flex; justify-content:space-between; align-items:center; gap:0.5rem;
}
.set-header input {
  border-radius:0.3rem; padding:0.5rem; flex:1;
  font-size:1rem; background:none; border:1px solid #ccc;
}

.set-details {
  font-size:0.9rem; display:flex; flex-direction:column; gap:0.2rem;
}
progress {
  width:100%; height:1rem; border-radius:0.3rem;
}

/* Schedule */
.schedule {
  margin-top:0.5rem; font-size:0.9rem; display:none;
}
.schedule-day {
  display:flex; justify-content:space-between; margin-bottom:0.2rem;
}
.schedule strong {
  display:block; margin-bottom:0.5rem; font-weight:600;
  letter-spacing:0.02rem;
}

.toggle-schedule {
  /* Replaced with btn-secondary class */
  display:inline-block; margin-top:0.5rem; padding:0.3rem 0.7rem; border-radius:0.3rem; cursor:pointer;
  font-size:0.9rem; font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.05rem;
}

/* Update Progress Form */
.update-progress-form {
  display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;
  margin-top:0.5rem;
}
.update-progress-form input[type="number"] {
  width:4rem; border-radius:0.3rem; padding:0.3rem; border:1px solid #ccc;
}
.update-progress-form .increment-button {
  /* Replaced with btn-small and btn-success */
}
.update-progress-form button.action {
  /* Removed since updates are automatic */
}

/* Confirmation Modal */
.confirm-modal {
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);
  display:none; align-items:center; justify-content:center; z-index:10000;
}
.confirm-modal .modal-content {
  padding:1rem; border-radius:0.3rem; text-align:center; max-width:300px; margin:0 auto;
}
.confirm-modal .modal-content p {
  margin-bottom:1rem; font-size:1rem; font-weight:500;
}
.confirm-modal .modal-content button {
  /* Use btn-primary and btn-secondary */
}
.confirm-modal .modal-content #confirmRemoveYes {
  /* btn-danger */
}
.confirm-modal .modal-content #confirmRemoveNo {
  /* btn-secondary */
}
</style>
</head>
<body>

<header>
  <div class="header-center">
    <!-- Replaced icon with "EP" text -->
    <strong style="font-size: 1.5rem; letter-spacing: 0.1rem;">EP</strong>
  </div>
  <div class="header-right">
    <button id="addSetBtn" class="btn btn-primary">+ Add Set</button>
  </div>
</header>

<main>
  <form class="new-set-form" id="newSetForm">
    <input type="text" id="setName" placeholder="Set Name" required>
    <input type="number" id="totalTests" placeholder="Total Tests" min="1" required>
    <input type="number" id="totalDays" placeholder="Days" min="1" required>
    <button class="btn btn-primary action" type="submit">Create</button>
  </form>
  <div class="sets" id="setsContainer"></div>
</main>

<!-- Confirmation Modal -->
<div class="confirm-modal" id="confirmModal">
  <div class="modal-content">
    <p>Remove this set?</p>
    <button id="confirmRemoveYes" class="btn btn-danger">Yes</button>
    <button id="confirmRemoveNo" class="btn btn-secondary">No</button>
  </div>
</div>

<script>
(function(){
  let sets = JSON.parse(localStorage.getItem('examPreparatorSets') || '[]');
  let removeIndex = null;

  const newSetForm = document.getElementById('newSetForm');
  const setsContainer = document.getElementById('setsContainer');
  const addSetBtn = document.getElementById('addSetBtn');
  const confirmModal = document.getElementById('confirmModal');
  const confirmRemoveYes = document.getElementById('confirmRemoveYes');
  const confirmRemoveNo = document.getElementById('confirmRemoveNo');

  function saveSets() {
    localStorage.setItem('examPreparatorSets', JSON.stringify(sets));
  }

  function daysBetween(d1, d2) {
    const oneDay = 24*60*60*1000;
    return Math.floor((d2.getTime()-d1.getTime())/oneDay);
  }

  function addDaysToDate(date, days) {
    let result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
  }

  function formatDate(date) {
    return date.toDateString();
  }

  // Distribute tests evenly across remaining days
  function distributeTests(testsLeft, remainingDays) {
    if (remainingDays <= 0 || testsLeft <= 0) return [];
    const base = Math.floor(testsLeft / remainingDays);
    let remainder = testsLeft % remainingDays;
    let schedule = [];
    for (let i=0; i<remainingDays; i++) {
      let val = base + (remainder > 0 ? 1 : 0);
      remainder--;
      if (remainder < 0) remainder = 0;
      schedule.push(val);
    }
    return schedule;
  }

  function renderSets() {
    setsContainer.innerHTML = '';
    const now = new Date();
    sets.forEach((s, index) => {
      const startDate = new Date(s.startDate);
      const daysPassed = daysBetween(startDate, now);
      const total = s.total;
      const done = s.done || 0;
      const testsLeft = Math.max(total - done, 0);
      const totalDays = s.days;
      let remainingDays = totalDays - daysPassed;
      if (remainingDays < 0) remainingDays = 0;

      const testsPerDay = (remainingDays > 0) ? (testsLeft / remainingDays) : 0;
      const futureSchedule = distributeTests(testsLeft, remainingDays);
      const finishDate = addDaysToDate(startDate, s.days);

      const setEl = document.createElement('div');
      setEl.className = 'set';

      setEl.innerHTML = `
        <div class="set-header">
          <input type="text" value="${s.name}" data-index="${index}" title="Rename this set"/>
          <button class="btn btn-danger remove-set-btn" title="Remove Set">&times;</button>
        </div>
        <div class="set-details">
          <div>Total: ${total}</div>
          <div>Done: ${done}</div>
          <div>Left: ${testsLeft}</div>
          <div>Tests/Day: ${testsPerDay.toFixed(1)}</div>
          <div>Finish by: ${formatDate(finishDate)}</div>
          <progress value="${done}" max="${total}"></progress>
        </div>
        ${futureSchedule.length > 0 ? `
          <button class="btn btn-secondary toggle-schedule-btn" type="button">Show Schedule</button>
          <div class="schedule">
            <strong>Upcoming Schedule:</strong>
            ${futureSchedule.map((testsCount, i) => {
              const dayDate = addDaysToDate(now, i + 1);
              return `
                <div class="schedule-day">
                  <div>${formatDate(dayDate)}:</div>
                  <div>${testsCount} test${testsCount!==1?'s':''}</div>
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}
        <div class="update-progress-form">
          <input type="number" min="0" value="0" required>
          <button type="button" class="btn btn-small btn-success increment-button">+</button>
        </div>
      `;

      // Remove Set Button
      const removeBtn = setEl.querySelector('.remove-set-btn');
      removeBtn.addEventListener('click', () => {
        removeIndex = index;
        confirmModal.style.display = 'flex';
      });

      // Rename Set
      const nameInput = setEl.querySelector('.set-header input');
      nameInput.addEventListener('change', () => {
        s.name = nameInput.value.trim();
        saveSets();
      });

      // Update Progress Form
      const updateDiv = setEl.querySelector('.update-progress-form');
      const updateInput = updateDiv.querySelector('input[type="number"]');
      const incrementBtn = updateDiv.querySelector('.increment-button');

      // Handle increment button click
      incrementBtn.addEventListener('click', () => {
        let val = parseInt(updateInput.value, 10) || 0;
        val += 1;
        updateInput.value = val;
        updateProgress(val);
      });

      // Handle input change
      updateInput.addEventListener('change', () => {
        const val = parseInt(updateInput.value, 10) || 0;
        if(val < 0) {
          updateInput.value = 0;
          return;
        }
        updateProgress(val);
      });

      function updateProgress(val) {
        s.done += val;
        if(s.done > s.total) s.done = s.total;
        saveSets();
        renderSets();
      }

      // Toggle Schedule
      const toggleBtn = setEl.querySelector('.toggle-schedule-btn');
      const scheduleDiv = setEl.querySelector('.schedule');
      if (toggleBtn && scheduleDiv) {
        toggleBtn.addEventListener('click', () => {
          if (scheduleDiv.style.display === 'none' || scheduleDiv.style.display === '') {
            scheduleDiv.style.display = 'block';
            toggleBtn.textContent = 'Hide Schedule';
          } else {
            scheduleDiv.style.display = 'none';
            toggleBtn.textContent = 'Show Schedule';
          }
        });
      }

      setsContainer.appendChild(setEl);
    });
  }

  // Add Set Button
  addSetBtn.addEventListener('click', () => {
    newSetForm.style.display = (newSetForm.style.display === 'none' || newSetForm.style.display === '') ? 'flex' : 'none';
  });

  // New Set Form Submission
  newSetForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('setName').value.trim();
    const totalTests = parseInt(document.getElementById('totalTests').value,10);
    const totalDays = parseInt(document.getElementById('totalDays').value,10);
    if(!name || isNaN(totalTests) || isNaN(totalDays) || totalTests <=0 || totalDays <=0) return;
    const now = new Date();
    sets.push({name, total: totalTests, days: totalDays, done:0, startDate: now.toISOString()});
    saveSets();
    renderSets();
    document.getElementById('setName').value = '';
    document.getElementById('totalTests').value = '';
    document.getElementById('totalDays').value = '';
    newSetForm.style.display = 'none';
  });

  // Confirmation Modal Buttons
  confirmRemoveYes.addEventListener('click', () => {
    if(removeIndex !== null) {
      sets.splice(removeIndex,1);
      saveSets();
      renderSets();
      removeIndex = null;
    }
    confirmModal.style.display='none';
  });

  confirmRemoveNo.addEventListener('click', () => {
    confirmModal.style.display='none';
    removeIndex=null;
  });

  // Initialize
  renderSets();
})();
</script>
</body>
</html>
